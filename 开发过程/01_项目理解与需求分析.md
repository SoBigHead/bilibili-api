# 01. 项目理解与需求分析

## 一、项目结构初步认知

项目 `bilibili-api` 是一个 Python 项目，从其目录结构推测，其核心功能在于提供与哔哩哔哩（Bilibili）平台交互的API能力。

关键目录解读：

*   `bilibili_api/`: 项目的核心代码所在地。
    *   `clients/`: 可能包含直接与B站服务器进行API通信的客户端实现。
    *   `data/`: 用于存储静态数据，例如预设的API端点信息、验证码处理所需资源等。
    *   `exceptions/`: 定义了项目特定的异常类型，用于错误处理。
    *   `tools/`: 包含一些辅助工具，如数据解析器 (`parser/`) 或其他特定功能模块 (`ivitools/`)。
    *   `utils/`: 通用工具函数库。
*   `docs/`: 项目文档，包括使用示例、API模块说明等。
*   `tests/`: 单元测试和集成测试脚本。
*   `prd.md`: **产品需求文档**，详细描述了基于此项目要构建的应用功能和技术方案。
*   `pyproject.toml` / `requirements.txt`: Python 项目的依赖管理和构建配置文件。

## 二、`prd.md` 需求解读

`prd.md` 文件详细规划了一个 **"Cloudflare R2 + bilibili-api 视频下载平台"** 的技术架构方案。

其核心目标是：**构建一个允许用户通过输入B站视频链接，将视频下载并存储到 Cloudflare R2，最终提供给用户进行下载的在线平台。**

文档中涵盖了以下主要方面：

1.  **技术选型**：
    *   前端：Next.js (部署于 Vercel)
    *   后端：Node.js (部署于 Railway)
    *   存储：Cloudflare R2
    *   数据库：Railway PostgreSQL
2.  **Cloudflare R2 集成方案**：强调了R2的成本优势（尤其是零出站费用）和S3兼容API。
3.  **用户流程设计**：
    *   用户输入链接 -> 视频信息解析 (调用 `bilibili-api`) -> 下载配置 -> 任务创建 -> 视频下载处理 (FFmpeg合并音视频) -> 上传到R2 -> 用户下载。
4.  **成本和性能分析**：对运营成本和系统性能进行了预估。
5.  **部署和维护**：规划了部署流程和日常维护要点。

## 三、基于 `bilibili-api` 实现 `prd.md` 需求的初步思考

根据 `prd.md` 的需求，`bilibili-api` 项目在整个下载平台中扮演了至关重要的角色，主要体现在视频解析和下载流获取方面。

1.  **`bilibili-api` 的核心作用**：
    *   **视频信息解析**：需要提供功能来解析用户输入的B站视频URL（包括不同格式如完整链接、短链接、BV号），并返回视频的详细元数据，如：
        *   标题
        *   时长
        *   封面图
        *   可用的清晰度选项列表
        *   分P信息（如果是多P视频）
        *   UP主信息等
    *   **下载流获取**：根据用户选择的清晰度等参数，获取视频和音频的直接下载流地址。B站的视频和音频通常是分离的，因此需要分别获取。

2.  **与后端服务的集成**：
    *   `prd.md` 规划的后端是 Node.js。这意味着 Node.js 后端需要与 Python 的 `bilibili-api`进行交互。可能的交互方式包括：
        *   **子进程调用**：Node.js 执行 Python 脚本（`bilibili-api` 的命令行接口或特定脚本）并获取输出。
        *   **HTTP API 封装**：将 `bilibili-api` 的核心功能封装成一个轻量级的 HTTP API 服务（例如使用 Flask 或 FastAPI），Node.js 后端通过HTTP请求调用这个服务。这种方式更灵活，易于解耦和独立部署/扩展。
        *   **直接使用 Python 后端**：考虑到 `bilibili-api` 是 Python 项目，也可以直接选择 Python 技术栈（如 FastAPI）来构建后端服务，从而避免跨语言调用的复杂性，简化开发和维护。这个方案值得进一步评估。

3.  **需要确认 `bilibili-api` 的现有能力**：
    *   当前 `bilibili-api` 是否已经具备完善的视频信息解析功能？
    *   是否支持获取所有常见清晰度的视频流和音频流？
    *   API的稳定性和错误处理机制如何？
    *   是否有处理B站API限制（如请求频率、登录态要求等）的机制？

4.  **后端核心下载逻辑**：
    *   **任务管理**：使用如 Redis 的消息队列来管理下载任务，实现异步处理，提高系统的并发能力和响应速度。
    *   **音视频下载与合并**：
        *   分别下载视频流和音频流。
        *   使用 `FFmpeg`（或其他音视频处理库）将下载的音视频流合并成完整的视频文件。这部分逻辑需要在后端服务器上执行。
    *   **上传至 R2**：
        *   使用 Cloudflare R2 的 S3 兼容 API (例如通过 `boto3` 库的Python版或 AWS SDK for JavaScript) 将合并后的视频文件上传到指定的 R2 存储桶。
        *   生成预签名 URL (presigned URL) 供用户下载，确保安全性并利用 R2 的全球分发能力。
    *   **进度通知**：通过 WebSocket 将下载进度（如"正在下载视频流"、"正在下载音频流"、"正在合并"、"正在上传"）实时推送给前端。

5.  **需要补充的功能模块（如果 `bilibili-api` 本身不直接提供）**：
    *   如果 `bilibili-api` 只提供基础API调用，那么围绕它构建上述后端逻辑将是主要工作。
    *   用户认证与管理（`prd.md` 未明确提及，但实际应用中可能需要）。
    *   详细的错误处理和重试机制。

## 四、下一步行动

1.  **深入分析 `bilibili-api` 源代码**：详细阅读 `bilibili_api/` 目录下的代码，特别是 `clients/` 和 `tools/`，以确定其具体功能、API接口、数据结构和限制。
2.  **验证 `bilibili-api` 的核心功能**：尝试调用 `bilibili-api` 的相关函数或脚本，传入实际的B站视频链接，检查其是否能正确解析信息并获取下载流。
3.  **技术选型决策（后端）**：基于对 `bilibili-api` 的深入了解，以及 `prd.md` 的指导，最终确定后端是采用 Node.js + Python 子服务，还是纯 Python 后端。

此文档将持续更新，记录后续的开发决策和过程。

